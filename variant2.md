# Titanic

Задача Титаника одна из самых известных платформы Kaggle. Рано или поздно, любой начинающий специалист по данным возьмется за ее решение.

![Untitled](images/Untitled.png)

Данные по пассажирам представлены в виде csv файла `titanic.csv`.

Файл формата `csv` - это текстовый файл, в котором содержится информация в виде таблицы. Каждая строка - это отдельная строка таблицы, а столбцы отделены один от другого специальными символами - разделителями (например, запятой).

В нашем случае первые 5 пассажиров в файле csv представлены так:

```sql
PassengerId,Survived,Pclass,Name,Sex,Age,SibSp,Parch,Ticket,Fare,Cabin,Embarked
1,0,3,"Braund, Mr. Owen Harris",male,22,1,0,A/5 21171,7.25,,S
2,1,1,"Cumings, Mrs. John Bradley (Florence Briggs Thayer)",female,38,1,0,PC 17599,71.2833,C85,C
3,1,3,"Heikkinen, Miss. Laina",female,26,0,0,STON/O2. 3101282,7.925,,S
4,1,1,"Futrelle, Mrs. Jacques Heath (Lily May Peel)",female,35,1,0,113803,53.1,C123,S
5,0,3,"Allen, Mr. William Henry",male,35,0,0,373450,8.05,,S
```

Эти же данные можно представить в виде таблицы.

| PassengerId | Survived | Pclass | Name                                                | Sex    | Age | SibSp | Parch | Ticket           | Fare    | Cabin | Embarked |
| ----------- | -------- | ------ | --------------------------------------------------- | ------ | --- | ----- | ----- | ---------------- | ------- | ----- | -------- |
| 1           | 0        | 3      | Braund, Mr. Owen Harris                             | male   | 22  | 1     | 0     | A/5 21171        | 7.2500  |       | S        |
| 2           | 1        | 1      | Cumings, Mrs. John Bradley (Florence Briggs Thayer) | female | 38  | 1     | 0     | PC 17599         | 71.2833 | C85   | C        |
| 3           | 1        | 3      | Heikkinen, Miss. Laina                              | female | 26  | 0     | 0     | STON/O2. 3101282 | 7.9250  |       | S        |
| 4           | 1        | 1      | Futrelle, Mrs. Jacques Heath (Lily May Peel)        | female | 35  | 1     | 0     | 113803           | 53.1000 | C123  | S        |
| 5           | 0        | 3      | Allen, Mr. William Henry                            | male   | 35  | 0     | 0     | 373450           | 8.0500  |       | S        |

Значение столбцов представлено ниже.

| Столбец  | Значение                                                                                                       |
| -------- | -------------------------------------------------------------------------------------------------------------- |
| Survived | Признак того, выжил ли пассажир (1) или нет (0).                                                               |
| Pclass   | Класс, которым следовал пассажир (1, 2 и 3 классы).                                                            |
| Name     | Имя пассажира.                                                                                                 |
| Sex      | Пол пассажира (male - мужской, female - женский).                                                              |
| Age      | Возраст пассажира.                                                                                             |
| SibSp    | Число братьев, сестер или супругов на борту у человека.                                                        |
| Parch    | Подобно SibSp, этот признак содержал количество родителей или детей, с которыми путешествовал каждый пассажир. |
| Ticket   | Номе билета пассажира.                                                                                         |
| Fare     | Стоимость билета пассажира.                                                                                    |
| Cabin    | Номер каюты пассажира.                                                                                         |
| Embarked | Порт посадки пассажира (C — Шербур; Q — Квинстаун; S — Саутгемптон)                                            |

### Импорт данных в БД

СУБД PostgreSQL поддерживает импорт данных из файлов `csv`. Но для начала необходимо создать таблицу.

```sql
create table if not exists passengers  (
    id integer primary key,
    survived integer not null,
    pclass integer,
    pname text unique,
    sex varchar(6),
    age float,
    sibsp int,
    parch int,
    ticket text,
    fare float,
    cabin varchar(16),
    embarked varchar(16)
);
```

Для импорта данных необходимо выполнить SQL запрос:

```sql
COPY passengers FROM '<путь-до-файла>/train.csv' DELIMITER ',' CSV HEADER;
```

Например, если файл train.csv находится в корне диска C, то запрос выглядит следующим образом

```sql
COPY passengers FROM 'C:\train.csv' DELIMITER ',' CSV HEADER;
```

Для ОС Linux пусть к файлу необходимо писать от корня файловой системы. Например, если файл находится в домашнем каталоге пользователя user31, то запрос выглядит так:

```sql
COPY passengers FROM '/home/user31/train.csv' DELIMITER ',' CSV HEADER;
```

Если СУБД PostgreSQL запущена на удаленном сервере, то файл `train.csv` необходимо передать на данный сервер. Вместе с тем, если на сервере СУБД вы работаете не под ролью администратора СУБД, у вас могут отсутствовать права на чтение файлов из файловой системы. В этом случае удобно импортировать данные через веб интерфейс pgAdmin 4.

Откройте пункт меню Инструменты → Storage Manager.

![Untitled](images/Untitled%201.png)

В появившемся окне откройте дополнительное меню и выберите пункт Upload.

![Untitled](images/Untitled%202.png)

Перетащите файл `train.csv` на это окно или нажмите на прямоугольную область в окне, и выберите файл через диалог выбора файла браузера. Затем закройте меню загрузки файлов, нажав на кнопку вверху справа, как показано на скриншоте ниже.

![Untitled](images/Untitled%203.png)

Убедитесь, что в списке файлов теперь присутствует `train.csv`. Затем закройте Storage Manager.

![Untitled](images/Untitled%204.png)

Далее в Object Explorer в своей базе данных найдите созданную таблицу `passengers`. Нажмите правой кнопкой мыши по этой таблице и выберите пункт меню Import/Export data.

![Untitled](images/Untitled%205.png)

В появившемся окне выберите файл `train.csv` в пункте Имя файла, нажав на кнопку выбора файла, как показано на скриншоте. У Вас откроется Storage Manager, где уже присутствует ранее загруженный `train.csv`, который необходимо выбрать.

![Untitled](images/Untitled%206.png)

Далее перейдите на вкладку Параметры, где убедитесь, что пункт разделитель у вас выбран “,” (запятая), а также что активирован переключатель Заголовок. После чего нажмите кнопку OK.

![Untitled](images/Untitled%207.png)

В случае успешного импорта данных вы увидите сообщения, как на скриншоте ниже.

![Untitled](images/Untitled%208.png)

Проверить корректность заполнения данных можно с помощью запроса `select`.

![Untitled](images/Untitled%209.png)

## Общая задача

Основная задача — найти зависимости в данных, влияющие на вероятность выжить при крушении "Титаника".Мы будем работать только с обучающей выборкой (так как для тестовой выборки нет целевого признака - "Survived").

### **Пропущенные значения**

В данных имеются пропущенные значения для признаков `age`, `cabin` и `embarked`. Обычно пропущенные значения заполняются, например, нулями, средним по столбцу, медианой и пр. Для признаков `cabin` и `embarked` невозможно заполнить пропуски, поскольку это качественные признаки. Признак `age` количественный, и для него можно посчитать и среднее, и медиану.

### Задание 1

- Посчитайте среднее значение столбца `age` и количество значений `NULL` в нем;
- Напишите анонимную функцию на языке `plpgsql` (блок `do`), которая заменит значения `NULL` в столбце `age` на среднее значение.
- Снова посчитайте значение столбца `age` и количество значений `NULL` в нем. Количество значений `NULL` должно быть 0, а среднее измениться не должно.

Скриншоты с правильными ответами представлены ниже

Количество значений `NULL` до замены.

![Untitled](images/Untitled%2010.png)

Количество значений `NULL` после замены.

![Untitled](images/Untitled%2011.png)

### **Общая выживаемость**

В обучающем наборе имеется 891 пассажир, из них выживших 342 человека, что составляет 38,4% от общего количества.

### **Выживание на основе класса, которым следовал пассажир**

Титаник столкнулся с айсбергом в ночь с 14 на 15 апреля 1912 года. 14 апреля в 23:39 вперёд смотрящий доложил на капитанский мостик об айсберге прямо по курсу. Меньше чем через минуту произошло столкновение.

Столкновение произошло в 23:40 вечера, в 23:40 подавляющее большинство пассажиров и корабельной команды находились в своих каютах - уровень каюты влиял на шанс выживания, так как пассажиры нижних палуб, позднее узнали о столкновении и, соответственно, имели меньше времени добраться до верхней палубы.

Каюты Титаника разделялись на три класса: первый класс был ближе всего расположен к палубе Титаника, третий класс был ближе всего расположен ко дну судна, второй класс - между первым и третьим.

### Задание 2

- Написать функцию `get_stats_by_pclass` на языке `plpgsql`, которая принимает один параметр - значение класса, и возвращает класс, количество пассажиров в целом, количество только выживших пассажиров и процент выживших в данном классе. Параметр функции должен иметь значение по умолчанию - `NULL`, в этом случае необходимо возвращать статистику по всем классам.

Скриншоты с правильными ответами представлены ниже.

![Untitled](images/Untitled%2014.png)

![Untitled](images/Untitled%2015.png)

### **Выживание на основе титула из оригинального имени**

Признак с именами пассажиров - "Name" сам по себе не может рассказать нам что-то о выживаемости, но его можно использовать для создания новых признаков, которые будут иметь относительно более высокую предсказательную силу. Например, выделим из признака "Name" оригинальные титулы.

Посмотрим на количество оригинальных титулов в именах. Всего в данном датасете имеется 17 оригинальных титулов, большинство из них слишком разряжены, чтобы делать оценочные суждения. Например, в таких титулах как: Sir, Major наблюдается единичное количество вхождений, по сравнению с такими титулами, как Miss и Mr.

```sql
select
	substring(pname from '(?<=,\s)[\sA-z]+(?=\.)') as title_name,
	count(*) as total
from passengers
group by title_name;
```

![Untitled](images/Untitled%2016.png)

Чтобы сделать каждую группу актуальной и получить более общую оценку, объединим 17 титулов в обобщенные группы: Mr, Mrs, Miss и Master. Титул Master в 19 веке применялось по отношению к детям мужского пола, Miss применялось по отношению к незамужним женщинам, но в 19 веке незамужними были, в подавляющем большинстве, только молодые девушки и девочки, Mrs применялось по отношению к замужним женщинам, Mr - мужчина, неважно, замужний или нет.

В группу Mr обобщим всех мужчин, кроме детей "Master". В группу Miss будут входить все незамужние девушки и женщины, а в группу Mrs объединим всех замужних девушек и женщин, так же девушек и женщин в титулах которых предполагается, что они были замужем.

```sql
alter table passengers add column title_group text;
update passengers set title_group = (
	case
		when substring(pname from '(?<=,\s)[\sA-z]+(?=\.)')
			in ('Dr','Rev','Col','Major','Jonkheer','Sir','Don','Capt')
			and sex = 'male'
			then 'Mr'
		when substring(pname from '(?<=,\s)[\sA-z]+(?=\.)')
			in ('Mlle', 'Ms')
			and sex = 'female'
			then 'Miss'
		when substring(pname from '(?<=,\s)[\sA-z]+(?=\.)')
			in ('Dr','the Countess','Mme','Lady','Dona')
			and sex = 'female'
			then 'Mrs'
		else substring(pname from '(?<=,\s)[\sA-z]+(?=\.)')
       end
);
```

### Задание 3

- Написать функцию `get_stats_by_title_group` на языке `plpgsql`, которая принимает один параметр - значение титула, и возвращает титул, количество пассажиров в целом, количество только выживших пассажиров и процент выживших в данном титуле. Параметр функции должен иметь значение по умолчанию - `NULL`, в этом случае необходимо возвращать статистику по всем классам.

Скриншоты с правильными ответами представлены ниже.

![Untitled](images/Untitled%2017.png)

![Untitled](images/Untitled%2018.png)
